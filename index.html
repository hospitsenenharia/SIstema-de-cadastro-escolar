<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Escolar Web</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --azul:#1e3a8a;
  --azul2:#1e40af;
  --cinza:#f1f5f9;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--cinza);
}

/* TOPO */
header{
  height:60px;
  background:var(--azul);
  color:#fff;
  display:flex;
  align-items:center;
  padding:0 20px;
  position:fixed;
  width:100%;
  top:0;
  z-index:10;
}

/* MENU LATERAL */
aside{
  position:fixed;
  top:60px;
  left:0;
  width:220px;
  height:calc(100vh - 60px);
  background:var(--azul2);
  color:#fff;
  padding:15px;
}
aside a{
  display:block;
  color:#fff;
  padding:10px;
  text-decoration:none;
  border-radius:6px;
}
aside a:hover{background:rgba(255,255,255,.15)}

/* CONTEÃšDO */
main{
  margin-left:220px;
  margin-top:60px;
  padding:20px;
}

section{display:none}
.card{
  background:#fff;
  padding:20px;
  border-radius:8px;
  max-width:900px;
}

input,select,button{
  width:100%;
  padding:8px;
  margin:6px 0;
}

button{
  background:var(--azul);
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:hover{opacity:.9}

/* LOGIN */
#login{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
}
</style>
</head>

<body>

<header>
  <strong>SISTEMA ESCOLAR WEB</strong>
</header>

<!-- MENU -->
<aside id="menu" style="display:none">
  <a onclick="mostrar('listaAlunos')">ğŸ“ Alunos</a>
  <a onclick="novoAluno()">â• Novo aluno</a>
  <a onclick="logout()">ğŸšª Sair</a>
</aside>

<main>

<!-- LOGIN -->
<section id="login" style="display:block">
  <div class="card" style="max-width:400px">
    <h3>Login</h3>
    <input id="email" placeholder="E-mail">
    <input id="senha" type="password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
  </div>
</section>

<!-- LISTA -->
<section id="listaAlunos">
  <div class="card">
    <h3>ğŸ“ Alunos Aâ€“Z</h3>
    <div id="lista"></div>
  </div>
</section>

<!-- FICHA -->
<section id="fichaAluno">
  <div class="card">
    <h3>ğŸ“„ Ficha do Aluno</h3>

    <input id="fa_matricula" placeholder="MatrÃ­cula">
    <input id="fa_nome" placeholder="Nome completo">
    <input id="fa_nascimento" type="date">
    <input id="fa_sexo" placeholder="Sexo">
    <input id="fa_mae" placeholder="Nome da mÃ£e">
    <input id="fa_pai" placeholder="Nome do pai">
    <input id="fa_rg" placeholder="RG">
    <input id="fa_cpf" placeholder="CPF">
    <input id="fa_endereco" placeholder="EndereÃ§o">
    <input id="fa_cidade" placeholder="Cidade">
    <input id="fa_serie" placeholder="SÃ©rie">
    <input id="fa_turma" placeholder="Turma">
    <input id="fa_turno" placeholder="Turno">
    <input id="fa_ano" placeholder="Ano letivo">

    <button onclick="salvarFichaAluno()">ğŸ’¾ Salvar</button>
    <button onclick="mostrar('documentosAluno')">ğŸ“¤ Documentos</button>
    <button onclick="mostrar('historicoAluno')">ğŸ“˜ HistÃ³rico</button>
    <button onclick="mostrar('listaAlunos')">â¬… Voltar</button>
  </div>
</section>

<!-- DOCUMENTOS -->
<section id="documentosAluno">
  <div class="card">
    <h3>ğŸ“¤ Documentos</h3>

    <select id="tipoDocumento">
      <option value="rg">RG</option>
      <option value="cpf">CPF</option>
      <option value="historico">HistÃ³rico</option>
      <option value="residencia">ResidÃªncia</option>
      <option value="vacinacao">VacinaÃ§Ã£o</option>
    </select>

    <input type="file" id="arquivoDocumento">
    <button onclick="uploadDocumento()">Enviar</button>

    <ul id="listaDocumentos"></ul>
    <button onclick="mostrar('fichaAluno')">â¬… Voltar</button>
  </div>
</section>

<!-- HISTÃ“RICO -->
<section id="historicoAluno">
  <div class="card">
    <h3>ğŸ“˜ HistÃ³rico Escolar</h3>

    <input id="he_ano" placeholder="Ano letivo">
    <input id="he_escola" placeholder="Escola">
    <input id="he_serie" placeholder="SÃ©rie">
    <input id="he_situacao" placeholder="SituaÃ§Ã£o">
    <input id="he_obs" placeholder="ObservaÃ§Ãµes">

    <button onclick="salvarHistorico()">Salvar histÃ³rico</button>
    <ul id="listaHistorico"></ul>
    <button onclick="mostrar('fichaAluno')">â¬… Voltar</button>
  </div>
</section>

</main>

<script>
/* SUPABASE */
const supabaseClient = supabase.createClient(
  "https://favcrovzeihwwrjltlzj.supabase.co",
  "sb_publishable_z2qDUek-OLvnDOby7JUEuw_bvUnx7Lg"
);

let alunoAtualId=null;

/* TELAS */
function mostrar(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* LOGIN */
async function login(){
  const {error}=await supabaseClient.auth.signInWithPassword({
    email:email.value,
    password:senha.value
  });
  if(error){alert(error.message);return;}
  document.getElementById("menu").style.display="block";
  mostrar("listaAlunos");
  carregarAlunos();
}

/* LOGOUT */
async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

/* ALUNOS */
async function carregarAlunos(){
  const {data}=await supabaseClient.from("alunos").select("*").order("nome");
  lista.innerHTML=data.map(a=>`<p onclick='abrirFicha(${JSON.stringify(a)})'>ğŸ“ ${a.nome}</p>`).join("");
}

function novoAluno(){
  alunoAtualId=null;
  document.querySelectorAll("#fichaAluno input").forEach(i=>i.value="");
  mostrar("fichaAluno");
}

function abrirFicha(a){
  alunoAtualId=a.id;
  fa_matricula.value=a.matricula||"";
  fa_nome.value=a.nome||"";
  fa_nascimento.value=a.data_nascimento||"";
  fa_sexo.value=a.sexo||"";
  fa_mae.value=a.nome_mae||"";
  fa_pai.value=a.nome_pai||"";
  fa_rg.value=a.rg||"";
  fa_cpf.value=a.cpf||"";
  fa_endereco.value=a.endereco||"";
  fa_cidade.value=a.cidade||"";
  fa_serie.value=a.serie||"";
  fa_turma.value=a.turma||"";
  fa_turno.value=a.turno||"";
  fa_ano.value=a.ano_letivo||"";
  mostrar("fichaAluno");
}

async function salvarFichaAluno(){
  const dados={
    matricula:fa_matricula.value,
    nome:fa_nome.value,
    data_nascimento:fa_nascimento.value,
    sexo:fa_sexo.value,
    nome_mae:fa_mae.value,
    nome_pai:fa_pai.value,
    rg:fa_rg.value,
    cpf:fa_cpf.value,
    endereco:fa_endereco.value,
    cidade:fa_cidade.value,
    serie:fa_serie.value,
    turma:fa_turma.value,
    turno:fa_turno.value,
    ano_letivo:fa_ano.value
  };
  alunoAtualId
    ? await supabaseClient.from("alunos").update(dados).eq("id",alunoAtualId)
    : await supabaseClient.from("alunos").insert(dados);
  alert("Ficha salva");
  mostrar("listaAlunos");
  carregarAlunos();
}

/* DOCUMENTOS */
async function uploadDocumento(){
  const file=arquivoDocumento.files[0];
  if(!file||!alunoAtualId)return alert("Selecione aluno/arquivo");
  const path=`${alunoAtualId}/${tipoDocumento.value}_${file.name}`;
  await supabaseClient.storage.from("documentos-alunos").upload(path,file,{upsert:true});
  listarDocumentos();
}

async function listarDocumentos(){
  const {data}=await supabaseClient.storage.from("documentos-alunos").list(alunoAtualId);
  listaDocumentos.innerHTML=data.map(d=>`<li>${d.name}</li>`).join("");
}

/* HISTÃ“RICO */
async function salvarHistorico(){
  await supabaseClient.from("historico_escolar").insert({
    aluno_id:alunoAtualId,
    ano:he_ano.value,
    escola:he_escola.value,
    serie:he_serie.value,
    situacao:he_situacao.value,
    observacoes:he_obs.value
  });
  alert("HistÃ³rico salvo");
}
</script>

</body>
</html>
