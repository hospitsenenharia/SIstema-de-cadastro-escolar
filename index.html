<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema Escolar Web</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
header{height:60px;background:#1e3a8a;color:#fff;display:flex;align-items:center;padding:0 20px;position:fixed;width:100%;top:0}
aside{position:fixed;top:60px;left:0;width:220px;height:calc(100vh - 60px);background:#1e40af;color:#fff;padding:15px;display:none}
aside a{display:block;padding:10px;border-radius:6px;cursor:pointer}
aside a:hover{background:rgba(255,255,255,.15)}
main{margin-left:220px;margin-top:60px;padding:20px}
section{display:none}
.card{background:#fff;padding:20px;border-radius:8px;max-width:1000px}
input,select,button,textarea{width:100%;padding:8px;margin:6px 0}
button{background:#1e3a8a;color:#fff;border:none;border-radius:6px;cursor:pointer}
button:hover{opacity:.9}
.lista div{border-bottom:1px solid #eee;padding:6px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:10px}
small{color:#555}
</style>
</head>

<body>

<header><strong>SISTEMA ESCOLAR WEB</strong></header>

<aside id="menu">
  <a onclick="mostrar('dashboard')">ğŸ“Š Dashboard</a>
  <a onclick="mostrar('listaAlunos')">ğŸ“ Alunos</a>
  <a onclick="novoAluno()">â• Novo aluno</a>
  <a onclick="logout()">ğŸšª Sair</a>
</aside>

<main>

<!-- LOGIN -->
<section id="login" style="display:block">
  <div class="card" style="max-width:400px;margin:auto">
    <h3>Login</h3>
    <input id="email" placeholder="E-mail">
    <input id="senha" type="password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboard">
  <div class="card">
    <h3>ğŸ“Š Alunos por SÃ©rie</h3>
    <canvas id="grafico"></canvas>
  </div>
</section>

<!-- LISTA -->
<section id="listaAlunos">
  <div class="card">
    <h3>ğŸ“ Alunos</h3>
    <input id="busca" placeholder="Buscar nome ou matrÃ­cula" oninput="filtrar()">
    <div id="lista" class="lista"></div>
  </div>
</section>

<!-- FICHA -->
<section id="fichaAluno">
  <div class="card" id="fichaPDF">
    <h3>ğŸ“„ Ficha do Aluno</h3>

    <input id="fa_matricula" placeholder="MatrÃ­cula">
    <input id="fa_nome" placeholder="Nome completo">
    <input id="fa_nascimento" type="date">
    <input id="fa_sexo" placeholder="Sexo">
    <input id="fa_mae" placeholder="Nome da mÃ£e">
    <input id="fa_pai" placeholder="Nome do pai">
    <input id="fa_rg" placeholder="RG">
    <input id="fa_cpf" placeholder="CPF">
    <input id="fa_endereco" placeholder="EndereÃ§o">
    <input id="fa_cidade" placeholder="Cidade">
    <input id="fa_serie" placeholder="SÃ©rie">
    <input id="fa_turma" placeholder="Turma">
    <input id="fa_turno" placeholder="Turno">
    <input id="fa_ano" placeholder="Ano letivo">

    <button onclick="salvarAluno()">ğŸ’¾ Salvar</button>
    <button onclick="gerarFichaPDF()">ğŸ“„ PDF</button>
    <button onclick="mostrar('documentosAluno'); listarDocumentos()">ğŸ“ Documentos</button>
    <button onclick="mostrar('historicoAluno'); listarHistorico()">ğŸ“˜ HistÃ³rico</button>
    <button onclick="mostrar('boletimAluno'); carregarBoletim()">ğŸ“„ Boletim</button>
    <button onclick="mostrar('listaAlunos')">â¬… Voltar</button>
  </div>
</section>

<!-- DOCUMENTOS -->
<section id="documentosAluno">
  <div class="card">
    <h3>ğŸ“ Documentos</h3>
    <select id="doc_tipo">
      <option value="RG">RG</option>
      <option value="CPF">CPF</option>
      <option value="HistÃ³rico">HistÃ³rico</option>
      <option value="Comprovante">Comprovante</option>
    </select>
    <input type="file" id="doc_arquivo">
    <button onclick="uploadDocumento()">Enviar</button>
    <ul id="listaDocumentos"></ul>
    <button onclick="mostrar('fichaAluno')">â¬… Voltar</button>
  </div>
</section>

<!-- HISTÃ“RICO -->
<section id="historicoAluno">
  <div class="card">
    <h3>ğŸ“˜ HistÃ³rico Escolar</h3>
    <input id="h_ano" placeholder="Ano letivo">
    <input id="h_escola" placeholder="Escola">
    <input id="h_serie" placeholder="SÃ©rie">
    <input id="h_situacao" placeholder="SituaÃ§Ã£o">
    <textarea id="h_obs" placeholder="ObservaÃ§Ãµes"></textarea>
    <button onclick="salvarHistorico()">Salvar</button>
    <ul id="listaHistorico"></ul>
    <button onclick="mostrar('fichaAluno')">â¬… Voltar</button>
  </div>
</section>

<!-- BOLETIM -->
<section id="boletimAluno">
  <div class="card" id="boletimPDF">
    <h3>ğŸ“„ Boletim</h3>
    <input id="disciplina" placeholder="Disciplina">
    <input id="nota" placeholder="Nota">
    <button onclick="salvarNota()">Adicionar</button>
    <div id="listaNotas"></div>
    <strong>MÃ©dia: <span id="media">0</span></strong>
    <button onclick="gerarBoletimPDF()">ğŸ“„ PDF</button>
    <button onclick="exportarXML()">ğŸ“„ XML</button>
    <button onclick="window.print()">ğŸ–¨ï¸ Imprimir</button>
    <button onclick="mostrar('fichaAluno')">â¬… Voltar</button>
  </div>
</section>

</main>

<script>
/* CONFIG */
const supabaseClient = supabase.createClient(
  "https://favcrovzeihwwrjltlzj.supabase.co",
  "SUA_ANON_KEY_AQUI"
);

let alunos=[], alunoAtual=null;

/* TELAS */
function mostrar(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* LOGIN */
async function login(){
  const { error } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: senha.value
  });
  if(error) return alert(error.message);
  menu.style.display="block";
  mostrar("dashboard");
  carregarDashboard();
  carregarAlunos();
}

/* LOGOUT */
async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

/* DASHBOARD */
async function carregarDashboard(){
  const { data } = await supabaseClient.from("alunos").select("serie");
  const map={};
  data.forEach(a=>map[a.serie]=(map[a.serie]||0)+1);
  new Chart(grafico,{type:"bar",data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]}});
}

/* ALUNOS */
async function carregarAlunos(){
  const { data } = await supabaseClient.from("alunos").select("*").order("nome");
  alunos=data||[];
  render(alunos);
}

function render(lista){
  lista.innerHTML = lista.map(a=>`
    <div>
      <span onclick='abrir(${JSON.stringify(a)})'>ğŸ“ ${a.nome} (${a.matricula})</span>
      <button style="background:#dc2626;width:auto" onclick="excluirAluno('${a.id}')">ğŸ—‘ï¸</button>
    </div>`).join("");
}

function filtrar(){
  const t=busca.value.toLowerCase();
  render(alunos.filter(a=>a.nome.toLowerCase().includes(t)||a.matricula.toLowerCase().includes(t)));
}

function novoAluno(){
  alunoAtual=null;
  document.querySelectorAll("#fichaAluno input").forEach(i=>i.value="");
  mostrar("fichaAluno");
}

function abrir(a){
  alunoAtual=a.id;
  fa_matricula.value=a.matricula||"";
  fa_nome.value=a.nome||"";
  fa_nascimento.value=a.data_nascimento||"";
  fa_sexo.value=a.sexo||"";
  fa_mae.value=a.nome_mae||"";
  fa_pai.value=a.nome_pai||"";
  fa_rg.value=a.rg||"";
  fa_cpf.value=a.cpf||"";
  fa_endereco.value=a.endereco||"";
  fa_cidade.value=a.cidade||"";
  fa_serie.value=a.serie||"";
  fa_turma.value=a.turma||"";
  fa_turno.value=a.turno||"";
  fa_ano.value=a.ano_letivo||"";
  mostrar("fichaAluno");
}

async function salvarAluno(){
  const dados={
    matricula:fa_matricula.value,
    nome:fa_nome.value,
    data_nascimento:fa_nascimento.value,
    sexo:fa_sexo.value,
    nome_mae:fa_mae.value,
    nome_pai:fa_pai.value,
    rg:fa_rg.value,
    cpf:fa_cpf.value,
    endereco:fa_endereco.value,
    cidade:fa_cidade.value,
    serie:fa_serie.value,
    turma:fa_turma.value,
    turno:fa_turno.value,
    ano_letivo:fa_ano.value
  };
  alunoAtual
    ? await supabaseClient.from("alunos").update(dados).eq("id",alunoAtual)
    : await supabaseClient.from("alunos").insert(dados);
  alert("Salvo");
  mostrar("listaAlunos");
  carregarAlunos();
}

async function excluirAluno(id){
  if(!confirm("Excluir aluno?")) return;
  await supabaseClient.from("alunos").delete().eq("id",id);
  carregarAlunos();
}

/* DOCUMENTOS */
async function uploadDocumento(){
  const f=doc_arquivo.files[0];
  if(!f||!alunoAtual) return;
  const path=`${alunoAtual}/${Date.now()}_${f.name}`;
  await supabaseClient.storage.from("documentos-alunos").upload(path,f);
  await supabaseClient.from("documentos_aluno").insert({
    aluno_id:alunoAtual,tipo:doc_tipo.value,nome_arquivo:f.name,caminho:path
  });
  listarDocumentos();
}

async function listarDocumentos(){
  const { data } = await supabaseClient.from("documentos_aluno").select("*").eq("aluno_id",alunoAtual);
  listaDocumentos.innerHTML=data.map(d=>`<li><a target="_blank"
  href="https://favcrovzeihwwrjltlzj.supabase.co/storage/v1/object/public/documentos-alunos/${d.caminho}">
  ${d.tipo} - ${d.nome_arquivo}</a></li>`).join("");
}

/* HISTÃ“RICO */
async function salvarHistorico(){
  await supabaseClient.from("historico_escolar").insert({
    aluno_id:alunoAtual,
    ano_letivo:h_ano.value,
    escola:h_escola.value,
    serie:h_serie.value,
    situacao:h_situacao.value,
    observacoes:h_obs.value
  });
  listarHistorico();
}

async function listarHistorico(){
  const { data } = await supabaseClient.from("historico_escolar").select("*").eq("aluno_id",alunoAtual);
  listaHistorico.innerHTML=data.map(h=>`<li>${h.ano_letivo} - ${h.serie} - ${h.situacao}</li>`).join("");
}

/* BOLETIM */
async function salvarNota(){
  await supabaseClient.from("boletins").insert({
    aluno_id:alunoAtual,
    disciplina:disciplina.value,
    nota:nota.value
  });
  disciplina.value="";nota.value="";
  carregarBoletim();
}

async function carregarBoletim(){
  const { data } = await supabaseClient.from("boletins").select("*").eq("aluno_id",alunoAtual);
  let soma=0;
  listaNotas.innerHTML=data.map(n=>{soma+=Number(n.nota);return `<p>${n.disciplina}: ${n.nota}</p>`}).join("");
  media.innerText=(soma/(data.length||1)).toFixed(2);
}

function gerarBoletimPDF(){
  html2pdf().from(document.getElementById("boletimPDF")).save("boletim.pdf");
}

function exportarXML(){
  let xml="<boletim>";
  document.querySelectorAll("#listaNotas p").forEach(p=>xml+=`<nota>${p.innerText}</nota>`);
  xml+=`<media>${media.innerText}</media></boletim>`;
  const b=new Blob([xml],{type:"application/xml"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="boletim.xml";
  a.click();
}
</script>

</body>
</html>
