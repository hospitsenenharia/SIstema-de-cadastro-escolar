<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Sistema Escolar Web</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<!-- CHART -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
header{height:60px;background:#1e3a8a;color:#fff;display:flex;align-items:center;padding:0 20px;position:fixed;width:100%;top:0}
aside{position:fixed;top:60px;left:0;width:220px;height:calc(100vh - 60px);background:#1e40af;color:#fff;padding:15px;display:none}
aside a{display:block;padding:10px;border-radius:6px;cursor:pointer}
aside a:hover{background:rgba(255,255,255,.15)}
main{margin-left:220px;margin-top:60px;padding:20px}
section{display:none}
.card{background:#fff;padding:20px;border-radius:8px;max-width:1000px}
input,select,button{width:100%;padding:8px;margin:6px 0}
button{background:#1e3a8a;color:#fff;border:none;border-radius:6px;cursor:pointer}
button:hover{opacity:.9}
.lista p{cursor:pointer;padding:6px;border-bottom:1px solid #eee}
.filtros{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:6px}
</style>
</head>

<body>

<header><strong>SISTEMA ESCOLAR WEB</strong></header>

<aside id="menu">
  <a onclick="mostrar('dashboard')">ğŸ“Š Dashboard</a>
  <a onclick="mostrar('listaAlunos')">ğŸ“ Alunos</a>
  <a id="menuNovo" onclick="novoAluno()">â• Novo aluno</a>
  <a id="menuUsuarios" onclick="mostrar('usuariosAdmin'); listarUsuarios()">ğŸ‘¥ UsuÃ¡rios</a>
  <a onclick="logout()">ğŸšª Sair</a>
</aside>

<main>

<!-- LOGIN -->
<section id="login" style="display:block">
  <div class="card" style="max-width:400px;margin:auto">
    <h3>Login</h3>
    <input id="email" placeholder="E-mail">
    <input id="senha" type="password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboard">
  <div class="card">
    <h3>ğŸ“Š Dashboard</h3>
    <canvas id="grafSerie"></canvas>
  </div>
</section>

<!-- LISTA -->
<section id="listaAlunos">
  <div class="card">
    <h3>ğŸ“ Alunos Aâ€“Z</h3>
    <div class="filtros">
      <input id="busca" placeholder="Buscar nome" oninput="filtrar()">
    </div>
    <div id="lista" class="lista"></div>
  </div>
</section>

<!-- FICHA -->
<section id="fichaAluno">
  <div class="card" id="fichaPDF">
    <h3>ğŸ“„ Ficha do Aluno</h3>
    <input id="fa_matricula" placeholder="MatrÃ­cula">
    <input id="fa_nome" placeholder="Nome">
    <input id="fa_serie" placeholder="SÃ©rie">
    <input id="fa_turma" placeholder="Turma">
    <input id="fa_turno" placeholder="Turno">
    <button onclick="salvarAluno()">ğŸ’¾ Salvar</button>
    <button onclick="gerarPDF()">ğŸ“„ PDF</button>
    <button onclick="mostrar('listaAlunos')">â¬… Voltar</button>
  </div>
</section>

<!-- USUÃRIOS -->
<section id="usuariosAdmin">
  <div class="card">
    <h3>ğŸ‘¥ UsuÃ¡rios</h3>
    <div id="listaUsuarios"></div>
  </div>
</section>

</main>

<script>
/* CONFIG */
const supabaseClient = supabase.createClient(
  "https://favcrovzeihwwrjltlzj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhdmNyb3Z6ZWlod3dyamx0bHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MzYwMjMsImV4cCI6MjA4MTUxMjAyM30.1PpWyZSBBItxNPXP0WyeyZJuILH7SnU7xiMOH9UPXMo"
);


let perfil="", escola_id="", alunosCache=[], alunoAtual=null;

/* TELAS */
function mostrar(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* LOGIN */
async function login(){
  try{
    const emailVal = document.getElementById("email").value;
    const senhaVal = document.getElementById("senha").value;

    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email: emailVal,
      password: senhaVal
    });

    if(error) throw error;

    const userId = data.user.id;

    const { data: usuario, error: errUser } = await supabaseClient
      .from("usuarios")
      .select("*")
      .eq("id", userId)
      .single();

    if(errUser || !usuario){
      alert("UsuÃ¡rio nÃ£o cadastrado na tabela usuarios");
      await supabaseClient.auth.signOut();
      return;
    }

    perfil = usuario.perfil;
    escola_id = usuario.escola_id;

    if(perfil !== "admin") document.getElementById("menuUsuarios").style.display="none";
    if(perfil === "professor") document.getElementById("menuNovo").style.display="none";

    document.getElementById("menu").style.display="block";

    mostrar("listaAlunos");
    carregarAlunos();

  }catch(e){
    alert("Erro no login: " + e.message);
  }
}

/* LOGOUT */
async function logout(){
  await supabaseClient.auth.signOut();
  location.reload();
}

/* DASHBOARD */
async function carregarDashboard(){
  const { data } = await supabaseClient
    .from("alunos")
    .select("serie")
    .eq("escola_id", escola_id);

  if(!data) return;

  const map={};
  data.forEach(a=>map[a.serie]=(map[a.serie]||0)+1);

  new Chart(document.getElementById("grafSerie"),{
    type:"bar",
    data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]}
  });
}

/* ALUNOS */
async function carregarAlunos(){
  const { data } = await supabaseClient
    .from("alunos")
    .select("*")
    .eq("escola_id", escola_id)
    .order("nome");

  alunosCache = data || [];
  render(alunosCache);
}

function render(lista){
  document.getElementById("lista").innerHTML = lista.map(a =>
    `<p onclick='abrir(${JSON.stringify(a)})'>ğŸ“ ${a.nome}</p>`
  ).join("");
}

function filtrar(){
  const termo = document.getElementById("busca").value.toLowerCase();
  render(alunosCache.filter(a => a.nome.toLowerCase().includes(termo)));
}

function novoAluno(){
  alunoAtual=null;
  document.querySelectorAll("#fichaAluno input").forEach(i=>i.value="");
  mostrar("fichaAluno");
}

function abrir(a){
  alunoAtual=a.id;
  fa_nome.value=a.nome;
  fa_matricula.value=a.matricula;
  fa_serie.value=a.serie;
  fa_turma.value=a.turma;
  fa_turno.value=a.turno;
  mostrar("fichaAluno");
}

async function salvarAluno(){
  const dados={
    nome:fa_nome.value,
    matricula:fa_matricula.value,
    serie:fa_serie.value,
    turma:fa_turma.value,
    turno:fa_turno.value,
    escola_id
  };

  alunoAtual
    ? await supabaseClient.from("alunos").update(dados).eq("id",alunoAtual)
    : await supabaseClient.from("alunos").insert(dados);

  alert("Aluno salvo");
  mostrar("listaAlunos");
  carregarAlunos();
}

/* PDF */
function gerarPDF(){
  html2pdf().from(document.getElementById("fichaPDF")).save("ficha-aluno.pdf");
}

/* USUÃRIOS */
async function listarUsuarios(){
  const { data } = await supabaseClient.from("usuarios").select("*");
  document.getElementById("listaUsuarios").innerHTML =
    (data||[]).map(u=>`<p>${u.email} (${u.perfil})</p>`).join("");
}
</script>

</body>
</html>
